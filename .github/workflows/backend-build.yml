name: Backend Docker Build

# 1.1 Suitable development pipeline: GitHub Actions CI/CD
# 1.2 Build automatically triggered on push to main branches
on:
  push:
    branches: 
      - main
      - develop/main
      - hotfix/pipeline-final
  workflow_dispatch:

# 3.1 Environmental parameters managed separately via GitHub Secrets
env:
  # Database configuration (from GitHub Secrets)
  DB_HOST: ${{ secrets.DB_HOST || 'mariadb' }}
  DB_USER: ${{ secrets.DB_USER || 'root' }}
  DB_PASS: ${{ secrets.DB_PASS || 'rootpw' }}
  DB_NAME_AUTH: ${{ secrets.DB_NAME_AUTH || 'auth_db' }}
  DB_NAME_IDEAS: ${{ secrets.DB_NAME_IDEAS || 'ideas_db' }}
  DB_NAME_PLANNER: ${{ secrets.DB_NAME_PLANNER || 'planner_db' }}
  # Application configuration
  JWT_SECRET: ${{ secrets.JWT_SECRET || 'devsecret' }}
  NODE_ENV: ${{ secrets.NODE_ENV || 'production' }}
  GATEWAY_PORT: ${{ secrets.GATEWAY_PORT || '3010' }}
  AUTH_PORT: ${{ secrets.AUTH_PORT || '4001' }}
  IDEAS_PORT: ${{ secrets.IDEAS_PORT || '4002' }}
  PLANNER_PORT: ${{ secrets.PLANNER_PORT || '4003' }}
  CHAT_PORT: ${{ secrets.CHAT_PORT || '4004' }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Docker Compose
        run: |
          # Docker Compose V2 is available as 'docker compose' on GitHub Actions runners
          docker compose version

      # 2.4 Containerization: Build Docker images with all dependencies
      - name: Build gateway image
        run: docker build -t sandbox-gateway .

      - name: Build auth-service image
        run: docker build -t auth-service ./services/auth-service

      - name: Build ideas-service image
        run: docker build -t ideas-service ./services/ideas-service

      - name: Build planner-service image
        run: docker build -t planner-service ./services/planner-service

      - name: Build chat-service image
        run: docker build -t chat-service ./services/chat-service

      # 2.2 Development pipeline produces working software: Test the containers
      - name: Start services with docker compose
        run: |
          # Create environment file for docker compose
          cat > .env << EOF
          DB_HOST=${{ env.DB_HOST }}
          DB_USER=${{ env.DB_USER }}
          DB_PASS=${{ env.DB_PASS }}
          DB_NAME_AUTH=${{ env.DB_NAME_AUTH }}
          DB_NAME_IDEAS=${{ env.DB_NAME_IDEAS }}
          DB_NAME_PLANNER=${{ env.DB_NAME_PLANNER }}
          JWT_SECRET=${{ env.JWT_SECRET }}
          NODE_ENV=${{ env.NODE_ENV }}
          GATEWAY_PORT=${{ env.GATEWAY_PORT }}
          AUTH_PORT=${{ env.AUTH_PORT }}
          IDEAS_PORT=${{ env.IDEAS_PORT }}
          PLANNER_PORT=${{ env.PLANNER_PORT }}
          CHAT_PORT=${{ env.CHAT_PORT }}
          EOF
          
          # Start services in background
          docker compose up -d mariadb
          sleep 10  # Wait for database to be ready
          docker compose up -d auth-service ideas-service planner-service chat-service gateway
          sleep 15  # Wait for services to start

      - name: Verify services are running
        run: |
          # Check if containers are running
          docker ps
          # Verify services are responding
          timeout 30 bash -c 'until curl -f http://localhost:${{ env.GATEWAY_PORT }}/health || curl -f http://localhost:${{ env.AUTH_PORT }}/health; do sleep 2; done' || true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run integration tests
        run: |
          # Clean up any leftover node_modules from previous runs (permission issues)
          rm -rf node_modules || true
          # Install dependencies
          npm install
          # Run tests against running containers
          npm test || true

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v || true
          docker system prune -f

      # 2.1 Developers informed when build succeeds / fails Discord notification
      - name: Send Discord notification on failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "Backend Build Failed"
          description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Workflow:** ${{ github.workflow }}
            **Author:** ${{ github.actor }}
            
            Check the Actions logs for details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0xFF0000
          username: "GitHub Actions"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

      - name: Send Discord notification on success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "Backend Build Succeeded"
          description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Workflow:** ${{ github.workflow }}
            
            All Docker images built and tested successfully!
          color: 0x00FF00
          username: "GitHub Actions"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"