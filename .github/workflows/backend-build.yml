name: Backend Docker Build

on:
  push:
    branches: 
      - main
      - develop/main
      - 'feature/**'
      - 'hotfix/**' 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build gateway image (root Dockerfile)
      - name: Build gateway image
        run: docker build -t sandbox-gateway .

      # Build each service image
      - name: Build auth-service image
        run: docker build -t auth-service ./services/auth-service

      - name: Build ideas-service image
        run: docker build -t ideas-service ./services/ideas-service

      - name: Build planner-service image
        run: docker build -t planner-service ./services/planner-service

      # Discord webhook notification on failure
      - name: Send Discord notification on failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚ùå Backend Build Failed"
          description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Workflow:** ${{ github.workflow }}
            
            Check the Actions logs for details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0xFF0000
          username: "GitHub Actions"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"